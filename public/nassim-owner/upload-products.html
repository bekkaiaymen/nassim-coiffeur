<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±ÙØ¹ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† PDF - Nassim Owner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #CBA35C 0%, #D4AF37 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 40px;
        }
        
        .upload-area {
            border: 3px dashed #CBA35C;
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            background: #fff8e7;
            border-color: #D4AF37;
        }
        
        .upload-area.dragover {
            background: #fff8e7;
            border-color: #D4AF37;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .upload-area p {
            color: #666;
            font-size: 14px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .info-box h4 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-box ul {
            list-style: none;
            padding-right: 0;
        }
        
        .info-box li {
            color: #555;
            padding: 5px 0;
            font-size: 14px;
        }
        
        .info-box li::before {
            content: "âœ“ ";
            color: #4CAF50;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .progress-area {
            display: none;
            margin-top: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 40px;
            background: #e0e0e0;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .products-preview {
            display: none;
            margin-top: 30px;
        }
        
        .products-preview h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        .products-table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #555;
        }
        
        .products-table tr:hover {
            background: #f9f9f9;
        }
        
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .category-hair-care { background: #e3f2fd; color: #1976D2; }
        .category-beard-care { background: #fff3e0; color: #f57c00; }
        .category-styling { background: #f3e5f5; color: #7b1fa2; }
        .category-tools { background: #e8f5e9; color: #388e3c; }
        .category-other { background: #e0e0e0; color: #616161; }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #CBA35C 0%, #D4AF37 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(203, 163, 92, 0.4);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ Ø±ÙØ¹ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† PDF</h1>
            <p>Ø§Ø±ÙØ¹ Ù…Ù„Ù PDF ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</p>
        </div>
        
        <div class="content">
            <div class="info-box">
                <h4>ğŸ“‹ Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù…Ù„Ù PDF:</h4>
                <ul>
                    <li>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ | Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: Ø´Ø§Ù…Ø¨Ùˆ Ù„Ù„Ø´Ø¹Ø± | 500)</li>
                    <li>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ - Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: Ø¬Ù„ ØªØµÙÙŠÙ - 350)</li>
                    <li>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬: Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: Ø²ÙŠØª Ù„Ø­ÙŠØ©: 800)</li>
                    <li>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: ÙƒØ±ÙŠÙ… Ø§Ù„Ø´Ø¹Ø± 450)</li>
                </ul>
            </div>
            
            <div class="settings-box" style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                <h4 style="color: #f57c00; margin-bottom: 15px; font-size: 16px;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ØµÙˆØ±</h4>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                        <input type="checkbox" id="smartPricing" onchange="toggleSmartPricing()" checked 
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="color: #555; font-weight: bold; font-size: 15px;">
                            ğŸ§  Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ (Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©)
                        </span>
                    </label>
                    
                    <div id="smartPricingConfig" style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-top: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="color: #333; font-size: 14px; margin: 0;">âš™ï¸ ØªØ®ØµÙŠØµ Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ</h4>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="addPriceRange()" style="background: #4CAF50; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    â• Ø¥Ø¶Ø§ÙØ© Ù†Ø·Ø§Ù‚
                                </button>
                                <button onclick="resetSmartPricing()" style="background: #ff9800; color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                                    ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                                </button>
                            </div>
                        </div>
                        
                        <div id="priceRangesContainer" style="display: grid; gap: 12px;">
                            <!-- Ranges will be dynamically generated -->
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #1976d2; font-size: 13px;">ğŸ’¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø¨Ø§Ø´Ø±Ø©:</strong>
                                <button onclick="testPricing()" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 11px; cursor: pointer;">
                                    Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø¹Ø±
                                </button>
                            </div>
                            <div id="pricingPreview" style="font-size: 12px; color: #1565c0; line-height: 1.8;"></div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;" id="manualMarginSection">
                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: bold;">
                        ğŸ’° Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠØ¯ÙˆÙŠ (Ø¥Ø°Ø§ Ø£ÙÙ„ØºÙŠ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ):
                    </label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <input type="range" id="profitMargin" min="10" max="100" value="30" 
                               style="flex: 1; cursor: pointer; opacity: 0.5;" oninput="updateProfitMarginDisplay()" disabled>
                        <span id="profitMarginDisplay" style="font-size: 24px; font-weight: bold; color: #999; min-width: 60px;">30%</span>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ = Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ã— (1 + <span id="profitMarginCalc">30</span>%)
                    </p>
                </div>
                
                <script>
                    // Toggle manual margin visibility
                    document.getElementById('smartPricing').addEventListener('change', function() {
                        const manual = document.getElementById('manualMarginSection');
                        const slider = document.getElementById('profitMargin');
                        const display = document.getElementById('profitMarginDisplay');
                        
                        if (this.checked) {
                            manual.style.opacity = '0.5';
                            slider.disabled = true;
                            slider.style.opacity = '0.5';
                            display.style.color = '#999';
                        } else {
                            manual.style.opacity = '1';
                            slider.disabled = false;
                            slider.style.opacity = '1';
                            display.style.color = '#f57c00';
                        }
                    });
                    
                    // Initialize
                    useSmartPricing = true;
                </script>
                
                <div style="border-top: 1px solid #ffe0b2; padding-top: 15px; margin-top: 15px;">
                    <label style="display: block; margin-bottom: 10px; color: #555; font-weight: bold;">
                        ğŸ–¼ï¸ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:
                    </label>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="imageSource" value="pdf" checked style="margin-left: 8px;">
                            <span>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± Ù…Ù† PDF (Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠ 100%)</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="imageSource" value="internet" style="margin-left: 8px;">
                            <span>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ± Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª (Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ø¯Ù‚ÙŠÙ‚Ø©)</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="imageSource" value="none" style="margin-left: 8px;">
                            <span>Ø¨Ø¯ÙˆÙ† ØµÙˆØ± (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)</span>
                        </label>
                    </div>
                    
                    <div id="imageWarning" style="display: none; background: #fff9c4; border: 1px solid #fbc02d; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; color: #f57f17;">
                        âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù‚Ø¯ ÙŠØ¬Ù„Ø¨ ØµÙˆØ±Ø§Ù‹ Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© ÙˆÙ„ÙŠØ³Øª Ù†ÙØ³ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ÙŠÙÙØ¶Ù„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹.
                    </div>
                </div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“„</div>
                <h3>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù PDF</h3>
                <p>Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>
            
            <div class="progress-area" id="progressArea">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="status-message info" id="statusMessage">
                    Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...
                </div>
            </div>
            
            <div class="products-preview" id="productsPreview">
                <h3>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© (<span id="productCount">0</span>)</h3>
                <div style="overflow-x: auto;">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ØµÙˆØ±Ø©</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„ÙØ¦Ø©</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                <th>Ø§Ù„Ø±Ø¨Ø­</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="uploadBtn" onclick="uploadProducts()">
                        âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±
                    </button>
                    <button class="btn btn-secondary" onclick="resetUpload()">
                        ğŸ”„ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api'
            : 'https://nassim-coiffeur.onrender.com/api';
        const NASSIM_BUSINESS_ID = '69259331651b1babc1eb83dc';
        
        let extractedProducts = [];
        let extractedImages = [];
        let profitMargin = 0.3; // Default 30%
        let useSmartPricing = true;
        let priceRanges = [
            { min: 0, max: 200, margin: 90, color: '#4CAF50' },
            { min: 200, max: 500, margin: 60, color: '#2196F3' },
            { min: 500, max: 1000, margin: 45, color: '#FF9800' },
            { min: 1000, max: 2000, margin: 35, color: '#9C27B0' },
            { min: 2000, max: 5000, margin: 27, color: '#607D8B' },
            { min: 5000, max: Infinity, margin: 22, color: '#795548' }
        ];
        
        // PDF.js setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Smart pricing algorithm - different margins for different price ranges
        function calculateSmartSellingPrice(purchasePrice) {
            for (let range of priceRanges) {
                if (purchasePrice >= range.min && (purchasePrice < range.max || range.max === Infinity)) {
                    return Math.round(purchasePrice * (1 + range.margin / 100));
                }
            }
            return Math.round(purchasePrice * 1.3);
        }
        
        function renderPriceRanges() {
            const container = document.getElementById('priceRangesContainer');
            container.innerHTML = '';
            
            priceRanges.forEach((range, index) => {
                const isLast = index === priceRanges.length - 1;
                
                const div = document.createElement('div');
                div.className = 'price-range-item';
                div.style.borderLeft = `4px solid ${range.color}`;
                div.style.background = '#f8f9fa';
                div.style.padding = '10px';
                div.style.borderRadius = '4px';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.gap = '10px';
                
                div.innerHTML = `
                    <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: bold; color: #555; min-width: 80px;">
                            ${range.min} - ${isLast ? 'âˆ' : range.max} Ø¯Ø¬
                        </span>
                        
                        ${!isLast ? `
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="font-size: 12px; color: #777;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰:</span>
                            <input type="number" value="${range.max}" 
                                   onchange="updateRangeValue(${index}, 'max', this.value)"
                                   style="width: 70px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 12px; color: #777;">Ø§Ù„Ø±Ø¨Ø­:</span>
                        <input type="range" min="5" max="200" value="${range.margin}" 
                               oninput="updateRangeValue(${index}, 'margin', this.value)"
                               style="width: 100px;">
                        <span style="font-weight: bold; color: ${range.color}; min-width: 40px; text-align: left;">
                            ${range.margin}%
                        </span>
                        
                        ${!isLast ? `
                        <button onclick="removePriceRange(${index})" 
                                style="background: none; border: none; color: #ff5252; cursor: pointer; font-size: 18px; padding: 0 5px;">
                            Ã—
                        </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addPriceRange() {
            const lastRange = priceRanges[priceRanges.length - 1];
            const secondLast = priceRanges.length > 1 ? priceRanges[priceRanges.length - 2] : null;
            
            let newMin = 0;
            if (secondLast) {
                newMin = secondLast.max;
            }
            
            const newMax = lastRange.min + 1000;
            
            const newRange = {
                min: lastRange.min,
                max: newMax,
                margin: lastRange.margin + 5,
                color: getRandomColor()
            };
            
            lastRange.min = newMax;
            priceRanges.splice(priceRanges.length - 1, 0, newRange);
            renderPriceRanges();
        }

        function removePriceRange(index) {
            if (index >= priceRanges.length - 1) return;
            
            const rangeToRemove = priceRanges[index];
            const nextRange = priceRanges[index + 1];
            
            nextRange.min = rangeToRemove.min;
            
            priceRanges.splice(index, 1);
            renderPriceRanges();
        }

        function updateRangeValue(index, field, value) {
            value = parseInt(value);
            if (isNaN(value)) return;
            
            if (field === 'margin') {
                priceRanges[index].margin = value;
                renderPriceRanges();
            } else if (field === 'max') {
                if (value <= priceRanges[index].min) {
                    alert('Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰');
                    renderPriceRanges();
                    return;
                }
                
                priceRanges[index].max = value;
                if (index + 1 < priceRanges.length) {
                    priceRanges[index + 1].min = value;
                }
                renderPriceRanges();
            }
        }

        function getRandomColor() {
            const colors = ['#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#009688', '#4CAF50', '#FFC107', '#FF9800', '#FF5722'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function resetSmartPricing() {
            priceRanges = [
                { min: 0, max: 200, margin: 90, color: '#4CAF50' },
                { min: 200, max: 500, margin: 60, color: '#2196F3' },
                { min: 500, max: 1000, margin: 45, color: '#FF9800' },
                { min: 1000, max: 2000, margin: 35, color: '#9C27B0' },
                { min: 2000, max: 5000, margin: 27, color: '#607D8B' },
                { min: 5000, max: Infinity, margin: 22, color: '#795548' }
            ];
            renderPriceRanges();
        }

        function testPricing() {
            const price = prompt('Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø¯Ø¬):');
            if (price) {
                const p = parseFloat(price);
                const selling = calculateSmartSellingPrice(p);
                const profit = selling - p;
                const margin = ((profit / p) * 100).toFixed(1);
                
                const range = priceRanges.find(r => p >= r.min && (p < r.max || r.max === Infinity));
                
                document.getElementById('pricingPreview').innerHTML = `
                    Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡: <strong>${p} Ø¯Ø¬</strong><br>
                    Ø§Ù„Ù†Ø·Ø§Ù‚: <strong>${range.min} - ${range.max === Infinity ? 'âˆ' : range.max}</strong> (Ù‡Ø§Ù…Ø´ ${range.margin}%)<br>
                    Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…Ù‚ØªØ±Ø­: <strong style="color: #2e7d32; font-size: 14px;">${selling} Ø¯Ø¬</strong><br>
                    Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ: <strong>${profit} Ø¯Ø¬</strong> (${margin}%)
                `;
            }
        }
        
        function updateProfitMarginDisplay() {
            const margin = document.getElementById('profitMargin').value;
            profitMargin = margin / 100;
            document.getElementById('profitMarginDisplay').textContent = margin + '%';
            document.getElementById('profitMarginCalc').textContent = margin;
            
            if (extractedProducts.length > 0) {
                extractedProducts = extractedProducts.map(p => ({
                    ...p,
                    sellingPrice: useSmartPricing 
                        ? calculateSmartSellingPrice(p.purchasePrice)
                        : Math.round(p.purchasePrice * (1 + profitMargin))
                }));
                displayProducts(extractedProducts);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const radios = document.querySelectorAll('input[name="imageSource"]');
            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const warning = document.getElementById('imageWarning');
                    warning.style.display = e.target.value === 'internet' ? 'block' : 'none';
                });
            });
            
            renderPriceRanges();
        });
        
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('pdfFile');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handlePDFFile(files[0]);
            } else {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù PDF ÙÙ‚Ø·');
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handlePDFFile(e.target.files[0]);
            }
        });
        
        async function handlePDFFile(file) {
            showProgress();
            updateProgress(10, 'Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù PDF...');
            
            try {
                // Check file size and warn if too large
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > 50) {
                    const proceed = confirm(`Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (${fileSizeMB.toFixed(1)} MB).\nÙ‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹.\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ\n\nÙ†ØµÙŠØ­Ø©: Ø§Ø³ØªØ®Ø¯Ù… "Ø¨Ø¯ÙˆÙ† ØµÙˆØ±" Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©.`);
                    if (!proceed) {
                        hideProgress();
                        return;
                    }
                }
                
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                updateProgress(20, `Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${pdf.numPages} ØµÙØ­Ø©. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬...`);
                
                let fullText = '';
                extractedImages = [];
                
                // Process in batches for large files
                const BATCH_SIZE = 20; // Process 20 pages at a time
                const totalBatches = Math.ceil(pdf.numPages / BATCH_SIZE);
                
                for (let batch = 0; batch < totalBatches; batch++) {
                    const startPage = batch * BATCH_SIZE + 1;
                    const endPage = Math.min((batch + 1) * BATCH_SIZE, pdf.numPages);
                    
                    updateProgress(
                        20 + (batch / totalBatches * 50), 
                        `Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙØ­Ø§Øª ${startPage}-${endPage} Ù…Ù† ${pdf.numPages}...`
                    );
                    
                    // Extract text for this batch
                    for (let i = startPage; i <= endPage; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                        
                        // Small delay to prevent browser freeze
                        if (i % 5 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }
                    }
                    
                    // Clear memory periodically
                    if (batch % 5 === 0 && batch > 0) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                updateProgress(70, 'Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');
                
                extractedProducts = extractProducts(fullText);
                
                // Check if user wants images from PDF
                const imageSource = document.querySelector('input[name="imageSource"]:checked').value;
                
                if (imageSource === 'pdf') {
                    updateProgress(75, 'Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± Ù…Ù† PDF...');
                    
                    try {
                        // Extract images more efficiently (limit to reasonable number)
                        const maxImages = Math.min(pdf.numPages * 2, 20); // Max 20 images
                        
                        for (let i = 1; i <= pdf.numPages && extractedImages.length < maxImages; i++) {
                            const page = await pdf.getPage(i);
                            
                            // Render page to canvas (simpler approach)
                            const viewport = page.getViewport({ scale: 0.5 }); // Reduced scale for memory
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            
                            // Convert to blob (smaller size)
                            const blob = await new Promise(resolve => 
                                canvas.toBlob(resolve, 'image/jpeg', 0.7)
                            );
                            
                            if (blob && blob.size > 5000) {
                                extractedImages.push({
                                    blob: blob,
                                    url: URL.createObjectURL(blob),
                                    pageNum: i
                                });
                            }
                            
                            updateProgress(75 + (i / pdf.numPages * 15), `Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØµÙˆØ± ${i}/${pdf.numPages}...`);
                        }
                        
                        // Match images to products
                        for (let i = 0; i < Math.min(extractedProducts.length, extractedImages.length); i++) {
                            extractedProducts[i].imageBlob = extractedImages[i].blob;
                            extractedProducts[i].imageUrl = extractedImages[i].url;
                        }
                    } catch (imgError) {
                        console.warn('Image extraction failed, continuing without images:', imgError);
                        // Continue without images if extraction fails
                    }
                }
                
                updateProgress(100, `ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${extractedProducts.length} Ù…Ù†ØªØ¬ Ùˆ ${extractedImages.length} ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
                
                setTimeout(() => {
                    hideProgress();
                    displayProducts(extractedProducts);
                }, 1000);
                
            } catch (error) {
                console.error('Error processing PDF:', error);
                hideProgress();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù PDF. Ø¬Ø±Ø¨ Ù…Ù„Ù Ø£ØµØºØ± Ø£Ùˆ Ø§Ø®ØªØ± "Ø¨Ø¯ÙˆÙ† ØµÙˆØ±".');
            }
        }
        
        function extractProducts(text) {
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            const products = [];
            
            for (let line of lines) {
                line = line.trim();
                
                if (line.length < 3 || 
                    line.toLowerCase().includes('product') || 
                    line.toLowerCase().includes('price') ||
                    line.toLowerCase().includes('page')) {
                    continue;
                }
                
                let match = line.match(/^(.+?)\s*\|\s*(\d+(?:\.\d+)?)/);
                
                if (!match) match = line.match(/^(.+?)\s*-\s*(\d+(?:\.\d+)?)/);
                if (!match) match = line.match(/^(.+?):\s*(\d+(?:\.\d+)?)/);
                if (!match) match = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)$/);
                if (!match) {
                    match = line.match(/^(\d+(?:\.\d+)?)\s+(.+)$/);
                    if (match) match = [match[0], match[2], match[1]];
                }
                
                if (match) {
                    const name = match[1].trim();
                    const price = parseFloat(match[2]);
                    
                    if (name.length > 2 && price > 0 && price < 100000) {
                        const sellingPrice = useSmartPricing 
                            ? calculateSmartSellingPrice(price)
                            : Math.round(price * (1 + profitMargin));

                        products.push({
                            name: name,
                            purchasePrice: price,
                            sellingPrice: sellingPrice,
                            description: `${name} - Ù…Ù†ØªØ¬ Ø£ØµÙ„ÙŠ`,
                            category: detectCategory(name),
                            inStock: true,
                            stockQuantity: 10,
                            imageUrl: null,
                            imageBlob: null
                        });
                    }
                }
            }
            return products;
        }
        
        function detectCategory(name) {
            const nameLower = name.toLowerCase();
            if (nameLower.includes('Ø´Ø§Ù…Ø¨Ùˆ') || nameLower.includes('shampoo')) return 'hair-care';
            if (nameLower.includes('Ø²ÙŠØª') || nameLower.includes('oil')) return 'beard-care';
            if (nameLower.includes('Ø¬Ù„') || nameLower.includes('gel') || nameLower.includes('wax')) return 'styling';
            if (nameLower.includes('Ù…Ø§ÙƒÙŠÙ†Ø©') || nameLower.includes('machine') || nameLower.includes('clipper')) return 'tools';
            if (nameLower.includes('Ù…Ù‚Øµ') || nameLower.includes('scissors')) return 'tools';
            if (nameLower.includes('ÙØ±Ø´Ø§Ø©') || nameLower.includes('brush')) return 'tools';
            return 'other';
        }
        
        function getCategoryLabel(category) {
            const labels = {
                'hair-care': 'Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø´Ø¹Ø±',
                'beard-care': 'Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ù„Ø­ÙŠØ©',
                'styling': 'ØªØµÙÙŠÙ',
                'tools': 'Ø£Ø¯ÙˆØ§Øª',
                'other': 'Ø£Ø®Ø±Ù‰'
            };
            return labels[category] || category;
        }
        
        function displayProducts(products) {
            document.getElementById('productCount').textContent = products.length;
            
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = products.map((p, i) => {
                const profit = p.sellingPrice - p.purchasePrice;
                const margin = ((profit / p.purchasePrice) * 100).toFixed(0);
                
                return `
                <tr>
                    <td>${i + 1}</td>
                    <td>
                        ${p.imageUrl 
                            ? `<img src="${p.imageUrl}" alt="${p.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">` 
                            : '<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ“¦</div>'}
                    </td>
                    <td>${p.name}</td>
                    <td><span class="category-badge category-${p.category}">${getCategoryLabel(p.category)}</span></td>
                    <td>${p.purchasePrice} Ø¯Ø¬</td>
                    <td>${p.sellingPrice} Ø¯Ø¬</td>
                    <td style="color: #4CAF50; font-weight: bold;">
                        ${profit} Ø¯Ø¬
                        <br>
                        <span style="font-size: 11px; color: #666;">(${margin}%)</span>
                    </td>
                </tr>
                `;
            }).join('');
            
            document.getElementById('productsPreview').style.display = 'block';
        }
        
        async function uploadProducts() {
            if (extractedProducts.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø±ÙØ¹Ù‡Ø§');
                return;
            }
            
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
            
            showProgress();
            
            try {
                const token = localStorage.getItem('ownerToken') || localStorage.getItem('token');
                const imageSource = document.querySelector('input[name="imageSource"]:checked').value;
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < extractedProducts.length; i++) {
                    const product = extractedProducts[i];
                    
                    updateProgress(
                        (i / extractedProducts.length) * 100,
                        `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${i + 1} Ù…Ù† ${extractedProducts.length}...`
                    );
                    
                    try {
                        let imageUrl = null;
                        
                        // Handle image upload based on selected option
                        if (imageSource === 'pdf' && product.imageBlob) {
                            // Upload image from PDF to Cloudinary
                            const formData = new FormData();
                            formData.append('image', product.imageBlob, `${product.name}.jpg`);
                            
                            const imgResponse = await fetch(`${API_URL}/upload-image`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                },
                                body: formData
                            });
                            
                            if (imgResponse.ok) {
                                const imgData = await imgResponse.json();
                                imageUrl = imgData.url;
                            }
                        } else if (imageSource === 'internet') {
                            // Search for image on internet
                            const searchResponse = await fetch(`${API_URL}/upload-image/search`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ productName: product.name })
                            });
                            
                            if (searchResponse.ok) {
                                const searchData = await searchResponse.json();
                                if (searchData.success) {
                                    imageUrl = searchData.url;
                                }
                            }
                        }
                        
                        // Upload product with image URL
                        const response = await fetch(`${API_URL}/products`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                ...product,
                                business: NASSIM_BUSINESS_ID,
                                image: imageUrl,
                                imageBlob: undefined, // Remove blob before sending
                                imageUrl: undefined
                            })
                        });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error('Error uploading product:', error);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'âœ… Ø§ÙƒØªÙ…Ù„!');
                
                setTimeout(() => {
                    hideProgress();
                    alert(`âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­: ${successCount}\nâŒ ÙØ´Ù„: ${errorCount}\nğŸ“Š Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${extractedProducts.length}`);
                    
                    if (successCount > 0) {
                        resetUpload();
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±';
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error uploading products:', error);
                hideProgress();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
                btn.disabled = false;
                btn.textContent = 'âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±';
            }
        }
        
        function resetUpload() {
            extractedProducts = [];
            document.getElementById('pdfFile').value = '';
            document.getElementById('productsPreview').style.display = 'none';
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadBtn').textContent = 'âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±';
        }
        
        function showProgress() {
            document.getElementById('progressArea').style.display = 'block';
        }
        
        function hideProgress() {
            document.getElementById('progressArea').style.display = 'none';
        }
        
        function updateProgress(percent, message) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '%';
            
            const statusMsg = document.getElementById('statusMessage');
            statusMsg.textContent = message;
            statusMsg.className = 'status-message info';
        }
        
        function showError(message) {
            const statusMsg = document.getElementById('statusMessage');
            statusMsg.textContent = message;
            statusMsg.className = 'status-message error';
        }
    </script>
</body>
</html>
