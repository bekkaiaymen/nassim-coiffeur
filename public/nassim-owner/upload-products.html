<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±ÙØ¹ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† PDF - Nassim Owner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #CBA35C 0%, #D4AF37 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 40px;
        }
        
        .upload-area {
            border: 3px dashed #CBA35C;
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            background: #fff8e7;
            border-color: #D4AF37;
        }
        
        .upload-area.dragover {
            background: #fff8e7;
            border-color: #D4AF37;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .upload-area h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        .upload-area p {
            color: #666;
            font-size: 14px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .info-box h4 {
            color: #1976D2;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-box ul {
            list-style: none;
            padding-right: 0;
        }
        
        .info-box li {
            color: #555;
            padding: 5px 0;
            font-size: 14px;
        }
        
        .info-box li::before {
            content: "âœ“ ";
            color: #4CAF50;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .progress-area {
            display: none;
            margin-top: 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 40px;
            background: #e0e0e0;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .products-preview {
            display: none;
            margin-top: 30px;
        }
        
        .products-preview h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        .products-table th {
            background: #f5f5f5;
            font-weight: bold;
            color: #555;
        }
        
        .products-table tr:hover {
            background: #f9f9f9;
        }
        
        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .category-hair-care { background: #e3f2fd; color: #1976D2; }
        .category-beard-care { background: #fff3e0; color: #f57c00; }
        .category-styling { background: #f3e5f5; color: #7b1fa2; }
        .category-tools { background: #e8f5e9; color: #388e3c; }
        .category-other { background: #e0e0e0; color: #616161; }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #CBA35C 0%, #D4AF37 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(203, 163, 92, 0.4);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ›ï¸ Ø±ÙØ¹ Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† PDF</h1>
            <p>Ø§Ø±ÙØ¹ Ù…Ù„Ù PDF ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø±</p>
        </div>
        
        <div class="content">
            <div class="info-box">
                <h4>ğŸ“‹ Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù…Ù„Ù PDF:</h4>
                <ul>
                    <li>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ | Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: Ø´Ø§Ù…Ø¨Ùˆ Ù„Ù„Ø´Ø¹Ø± | 500)</li>
                    <li>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ - Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: Ø¬Ù„ ØªØµÙÙŠÙ - 350)</li>
                    <li>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬: Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: Ø²ÙŠØª Ù„Ø­ÙŠØ©: 800)</li>
                    <li>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø³Ø¹Ø± (Ù…Ø«Ø§Ù„: ÙƒØ±ÙŠÙ… Ø§Ù„Ø´Ø¹Ø± 450)</li>
                </ul>
            </div>
            
            <div class="settings-box" style="background: #fff3e0; border-left: 4px solid #ff9800; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                <h4 style="color: #f57c00; margin-bottom: 15px; font-size: 16px;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ØµÙˆØ±</h4>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: #555; font-weight: bold;">
                        ğŸ’° Ù‡Ø§Ù…Ø´ Ø§Ù„Ø±Ø¨Ø­ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:
                    </label>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <input type="range" id="profitMargin" min="10" max="100" value="30" 
                               style="flex: 1; cursor: pointer;" oninput="updateProfitMarginDisplay()">
                        <span id="profitMarginDisplay" style="font-size: 24px; font-weight: bold; color: #f57c00; min-width: 60px;">30%</span>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ = Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ Ã— (1 + <span id="profitMarginCalc">30</span>%)
                    </p>
                </div>
                
                <div style="border-top: 1px solid #ffe0b2; padding-top: 15px; margin-top: 15px;">
                    <label style="display: block; margin-bottom: 10px; color: #555; font-weight: bold;">
                        ğŸ–¼ï¸ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:
                    </label>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="imageSource" value="pdf" checked style="margin-left: 8px;">
                            <span>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ± Ù…Ù† PDF (Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠ 100%)</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="imageSource" value="internet" style="margin-left: 8px;">
                            <span>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ± Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª (Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ø¯Ù‚ÙŠÙ‚Ø©)</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="imageSource" value="none" style="margin-left: 8px;">
                            <span>Ø¨Ø¯ÙˆÙ† ØµÙˆØ± (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)</span>
                        </label>
                    </div>
                    
                    <div id="imageWarning" style="display: none; background: #fff9c4; border: 1px solid #fbc02d; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; color: #f57f17;">
                        âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù‚Ø¯ ÙŠØ¬Ù„Ø¨ ØµÙˆØ±Ø§Ù‹ Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø´Ø§Ø¨Ù‡Ø© ÙˆÙ„ÙŠØ³Øª Ù†ÙØ³ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ÙŠÙÙØ¶Ù„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØµÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹.
                    </div>
                </div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“„</div>
                <h3>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù PDF</h3>
                <p>Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>
            
            <div class="progress-area" id="progressArea">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="status-message info" id="statusMessage">
                    Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...
                </div>
            </div>
            
            <div class="products-preview" id="productsPreview">
                <h3>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© (<span id="productCount">0</span>)</h3>
                <div style="overflow-x: auto;">
                    <table class="products-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ØµÙˆØ±Ø©</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                                <th>Ø§Ù„ÙØ¦Ø©</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                <th>Ø§Ù„Ø±Ø¨Ø­</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                        </tbody>
                    </table>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="uploadBtn" onclick="uploadProducts()">
                        âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±
                    </button>
                    <button class="btn btn-secondary" onclick="resetUpload()">
                        ğŸ”„ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api'
            : 'https://nassim-coiffeur.onrender.com/api';
        const NASSIM_BUSINESS_ID = '69259331651b1babc1eb83dc';
        
        let extractedProducts = [];
        let extractedImages = [];
        let profitMargin = 0.3; // Default 30%
        
        // PDF.js setup
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // Update profit margin display
        function updateProfitMarginDisplay() {
            const margin = document.getElementById('profitMargin').value;
            profitMargin = margin / 100;
            document.getElementById('profitMarginDisplay').textContent = margin + '%';
            document.getElementById('profitMarginCalc').textContent = margin;
            
            // Recalculate if products already extracted
            if (extractedProducts.length > 0) {
                extractedProducts = extractedProducts.map(p => ({
                    ...p,
                    sellingPrice: Math.round(p.purchasePrice * (1 + profitMargin))
                }));
                displayProducts(extractedProducts);
            }
        }
        
        // Show/hide internet image warning
        document.addEventListener('DOMContentLoaded', () => {
            const radios = document.querySelectorAll('input[name="imageSource"]');
            radios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const warning = document.getElementById('imageWarning');
                    warning.style.display = e.target.value === 'internet' ? 'block' : 'none';
                });
            });
        });
        
        // Upload area events
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('pdfFile');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handlePDFFile(files[0]);
            } else {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù PDF ÙÙ‚Ø·');
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handlePDFFile(e.target.files[0]);
            }
        });
        
        async function handlePDFFile(file) {
            showProgress();
            updateProgress(10, 'Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù PDF...');
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                updateProgress(20, `Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØµÙˆØ± Ù…Ù† ${pdf.numPages} ØµÙØ­Ø©...`);
                
                let fullText = '';
                extractedImages = [];
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    
                    // Extract text
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                    
                    // Extract images
                    const ops = await page.getOperatorList();
                    for (let j = 0; j < ops.fnArray.length; j++) {
                        if (ops.fnArray[j] === pdfjsLib.OPS.paintImageXObject || 
                            ops.fnArray[j] === pdfjsLib.OPS.paintInlineImageXObject ||
                            ops.fnArray[j] === pdfjsLib.OPS.paintJpegXObject) {
                            try {
                                const imageName = ops.argsArray[j][0];
                                const image = await page.objs.get(imageName);
                                
                                if (image && image.width && image.height) {
                                    // Create canvas to extract image data
                                    const canvas = document.createElement('canvas');
                                    canvas.width = image.width;
                                    canvas.height = image.height;
                                    const ctx = canvas.getContext('2d');
                                    
                                    // Draw image data
                                    const imgData = ctx.createImageData(image.width, image.height);
                                    imgData.data.set(image.data);
                                    ctx.putImageData(imgData, 0, 0);
                                    
                                    // Convert to blob
                                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                                    
                                    if (blob && blob.size > 5000) { // Only images > 5KB (filter out icons/logos)
                                        extractedImages.push({
                                            blob: blob,
                                            url: URL.createObjectURL(blob),
                                            pageNum: i
                                        });
                                    }
                                }
                            } catch (imgError) {
                                console.log('Could not extract image:', imgError);
                            }
                        }
                    }
                    
                    updateProgress(20 + (i / pdf.numPages * 40), `Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙØ­Ø© ${i} Ù…Ù† ${pdf.numPages}...`);
                }
                
                updateProgress(65, `ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${extractedImages.length} ØµÙˆØ±Ø©. Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...`);
                
                extractedProducts = extractProducts(fullText);
                
                // Match images to products (simple: assign in order if available)
                if (extractedImages.length > 0) {
                    const imageSource = document.querySelector('input[name="imageSource"]:checked').value;
                    if (imageSource === 'pdf') {
                        for (let i = 0; i < Math.min(extractedProducts.length, extractedImages.length); i++) {
                            extractedProducts[i].imageBlob = extractedImages[i].blob;
                            extractedProducts[i].imageUrl = extractedImages[i].url;
                        }
                    }
                }
                
                updateProgress(100, `ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${extractedProducts.length} Ù…Ù†ØªØ¬ Ùˆ ${extractedImages.length} ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!`);
                
                setTimeout(() => {
                    hideProgress();
                    displayProducts(extractedProducts);
                }, 1000);
                
            } catch (error) {
                console.error('Error processing PDF:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù PDF. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ù„Ù ØµØ­ÙŠØ­.');
            }
        }
        
        function extractProducts(text) {
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            const products = [];
            
            for (let line of lines) {
                line = line.trim();
                
                // Skip headers and short lines
                if (line.length < 3 || 
                    line.toLowerCase().includes('product') || 
                    line.toLowerCase().includes('price') ||
                    line.toLowerCase().includes('Ù…Ù†ØªØ¬') ||
                    line.toLowerCase().includes('Ø³Ø¹Ø±')) {
                    continue;
                }
                
                // Try different patterns
                let match = line.match(/^(.+?)\s*\|\s*(\d+(?:\.\d+)?)/);
                
                if (!match) {
                    match = line.match(/^(.+?)\s*-\s*(\d+(?:\.\d+)?)/);
                }
                
                if (!match) {
                    match = line.match(/^(.+?):\s*(\d+(?:\.\d+)?)/);
                }
                
                if (!match) {
                    match = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)$/);
                }
                
                if (!match) {
                    match = line.match(/^(\d+(?:\.\d+)?)\s+(.+)$/);
                    if (match) {
                        match = [match[0], match[2], match[1]];
                    }
                }
                
                if (match) {
                    const name = match[1].trim();
                    const price = parseFloat(match[2]);
                    
                    if (name.length > 2 && price > 0 && price < 100000) {
                        products.push({
                            name: name,
                            purchasePrice: price,
                            sellingPrice: Math.round(price * (1 + profitMargin)),
                            description: `${name} - Ù…Ù†ØªØ¬ Ø£ØµÙ„ÙŠ`,
                            category: detectCategory(name),
                            inStock: true,
                            stockQuantity: 10,
                            imageUrl: null,
                            imageBlob: null
                        });
                    }
                }
            }
            
            return products;
        }
        
        function detectCategory(name) {
            const nameLower = name.toLowerCase();
            
            if (nameLower.includes('Ø´Ø§Ù…Ø¨Ùˆ') || nameLower.includes('shampoo')) return 'hair-care';
            if (nameLower.includes('Ø²ÙŠØª') || nameLower.includes('oil')) return 'hair-care';
            if (nameLower.includes('ÙƒØ±ÙŠÙ…') || nameLower.includes('cream')) return 'hair-care';
            if (nameLower.includes('Ø¬Ù„') || nameLower.includes('gel')) return 'styling';
            if (nameLower.includes('ÙˆØ§ÙƒØ³') || nameLower.includes('wax')) return 'styling';
            if (nameLower.includes('Ø¨ÙˆÙ…Ø§Ø¯Ø©') || nameLower.includes('pomade')) return 'styling';
            if (nameLower.includes('Ù„Ø­ÙŠØ©') || nameLower.includes('beard')) return 'beard-care';
            if (nameLower.includes('Ù…Ø§ÙƒÙŠÙ†Ø©') || nameLower.includes('machine') || nameLower.includes('clipper')) return 'tools';
            if (nameLower.includes('Ù…Ù‚Øµ') || nameLower.includes('scissors')) return 'tools';
            if (nameLower.includes('ÙØ±Ø´Ø§Ø©') || nameLower.includes('brush')) return 'tools';
            
            return 'other';
        }
        
        function getCategoryLabel(category) {
            const labels = {
                'hair-care': 'Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø´Ø¹Ø±',
                'beard-care': 'Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ù„Ø­ÙŠØ©',
                'styling': 'ØªØµÙÙŠÙ',
                'tools': 'Ø£Ø¯ÙˆØ§Øª',
                'other': 'Ø£Ø®Ø±Ù‰'
            };
            return labels[category] || category;
        }
        
        function displayProducts(products) {
            document.getElementById('productCount').textContent = products.length;
            
            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = products.map((p, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>
                        ${p.imageUrl 
                            ? `<img src="${p.imageUrl}" alt="${p.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;">` 
                            : '<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ“¦</div>'}
                    </td>
                    <td>${p.name}</td>
                    <td><span class="category-badge category-${p.category}">${getCategoryLabel(p.category)}</span></td>
                    <td>${p.purchasePrice} Ø¯Ø¬</td>
                    <td>${p.sellingPrice} Ø¯Ø¬</td>
                    <td style="color: #4CAF50; font-weight: bold;">${p.sellingPrice - p.purchasePrice} Ø¯Ø¬</td>
                </tr>
            `).join('');
            
            document.getElementById('productsPreview').style.display = 'block';
        }
        
        async function uploadProducts() {
            if (extractedProducts.length === 0) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„Ø±ÙØ¹Ù‡Ø§');
                return;
            }
            
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...';
            
            showProgress();
            
            try {
                const token = localStorage.getItem('ownerToken') || localStorage.getItem('token');
                const imageSource = document.querySelector('input[name="imageSource"]:checked').value;
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < extractedProducts.length; i++) {
                    const product = extractedProducts[i];
                    
                    updateProgress(
                        (i / extractedProducts.length) * 100,
                        `Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${i + 1} Ù…Ù† ${extractedProducts.length}...`
                    );
                    
                    try {
                        let imageUrl = null;
                        
                        // Handle image upload based on selected option
                        if (imageSource === 'pdf' && product.imageBlob) {
                            // Upload image from PDF to Cloudinary
                            const formData = new FormData();
                            formData.append('image', product.imageBlob, `${product.name}.jpg`);
                            
                            const imgResponse = await fetch(`${API_URL}/upload-image`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                },
                                body: formData
                            });
                            
                            if (imgResponse.ok) {
                                const imgData = await imgResponse.json();
                                imageUrl = imgData.url;
                            }
                        } else if (imageSource === 'internet') {
                            // Search for image on internet
                            const searchResponse = await fetch(`${API_URL}/upload-image/search`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ productName: product.name })
                            });
                            
                            if (searchResponse.ok) {
                                const searchData = await searchResponse.json();
                                if (searchData.success) {
                                    imageUrl = searchData.url;
                                }
                            }
                        }
                        
                        // Upload product with image URL
                        const response = await fetch(`${API_URL}/products`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                ...product,
                                business: NASSIM_BUSINESS_ID,
                                image: imageUrl,
                                imageBlob: undefined, // Remove blob before sending
                                imageUrl: undefined
                            })
                        });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error('Error uploading product:', error);
                        errorCount++;
                    }
                }
                
                updateProgress(100, 'âœ… Ø§ÙƒØªÙ…Ù„!');
                
                setTimeout(() => {
                    hideProgress();
                    alert(`âœ… ØªÙ… Ø¨Ù†Ø¬Ø§Ø­: ${successCount}\nâŒ ÙØ´Ù„: ${errorCount}\nğŸ“Š Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${extractedProducts.length}`);
                    
                    if (successCount > 0) {
                        resetUpload();
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±';
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error uploading products:', error);
                hideProgress();
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª');
                btn.disabled = false;
                btn.textContent = 'âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±';
            }
        }
        
        function resetUpload() {
            extractedProducts = [];
            document.getElementById('pdfFile').value = '';
            document.getElementById('productsPreview').style.display = 'none';
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadBtn').textContent = 'âœ… Ø±ÙØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±';
        }
        
        function showProgress() {
            document.getElementById('progressArea').style.display = 'block';
        }
        
        function hideProgress() {
            document.getElementById('progressArea').style.display = 'none';
        }
        
        function updateProgress(percent, message) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '%';
            
            const statusMsg = document.getElementById('statusMessage');
            statusMsg.textContent = message;
            statusMsg.className = 'status-message info';
        }
        
        function showError(message) {
            const statusMsg = document.getElementById('statusMessage');
            statusMsg.textContent = message;
            statusMsg.className = 'status-message error';
        }
    </script>
</body>
</html>
